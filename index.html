<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H5 2D 游戏</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        
        <div id="ui-layer">
            <!-- Notification Container -->
            <div id="notification-container"></div>

            <!-- Pause Button (Visible during gameplay) -->
            <button id="pause-btn" class="hidden" style="position: absolute; top: 20px; right: 20px; z-index: 20;">暂停</button>

            <!-- Buff Bar -->
            <div id="buff-bar" class="hidden" style="position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); z-index: 20; display: flex; flex-direction: column; gap: 10px; align-items: center;">
                <!-- Formations -->
                <div id="formation-bar" style="display: flex; gap: 10px;"></div>
                <!-- Buffs -->
                <div id="active-buff-bar" style="display: flex; gap: 10px;"></div>
            </div>

            <div id="start-screen" class="screen">
                <div class="lobby-container">
                    <div class="lobby-left">
                        <h1>H5 2D 游戏</h1>
                        
                        <div class="resource-group">
                            <div id="gold-display" style="color: #87CEEB; display: none;">灵石: 0</div>
                            <div id="spiritual-power-display" style="display: none; color: #2196F3;">灵力: 0</div>
                            <div id="exp-display-container" style="position: relative; cursor: pointer;" onclick="window.openCultivationScreen()">
                                <div id="exp-display">气血: 0</div>
                                <div id="exp-arrow" style="position: absolute; top: 0; right: 0; transform: translate(50%, -50%); color: #FF5252; font-weight: bold; display: none; font-size: 18px; text-shadow: 1px 1px 2px black;">⬆️</div>
                            </div>
                            
                            <!-- Meditation Panel (Compact) -->
                            <div id="meditation-panel" style="grid-column: span 2; position: relative; cursor: pointer; display: none; background: rgba(33, 150, 243, 0.2); border: 1px solid #2196F3; border-radius: 5px; padding: 8px;" onclick="window.openCultivationScreen()">
                                <div style="display: flex; align-items: center; width: 100%;">
                                    <div id="reiki-display" style="font-size: 16px; color: #00BFFF; font-weight: bold; margin-right: 15px;">灵气: 0</div>
                                    <div style="font-size: 12px; color: #ccc;">
                                        +<span id="meditation-rate">0</span>/s
                                        <span id="meditation-bonus" style="color: #4CAF50; margin-left: 5px; display: none;"></span>
                                    </div>
                                    <div id="formation-icon" style="display: none; color: #4CAF50; font-weight: bold; border: 1px solid #4CAF50; border-radius: 50%; width: 20px; height: 20px; text-align: center; line-height: 20px; font-size: 12px; margin-left: auto;">聚</div>
                                </div>
                                <div id="reiki-arrow" style="position: absolute; top: 0; right: 0; transform: translate(50%, -50%); color: #FF5252; font-weight: bold; display: none; font-size: 18px; text-shadow: 1px 1px 2px black;">⬆️</div>
                            </div>
                        </div>

                        <div class="action-buttons-grid">
                            <button id="start-btn">选择关卡</button>
                            <button id="upgrade-btn" style="background-color: #9C27B0;">修炼</button>
                            <button id="forging-btn" style="background-color: #FF9800;">锻造</button>
                            <button id="smelting-btn" style="background-color: #FF5722;">熔炼</button>
                            <button id="formation-btn" style="background-color: #3F51B5; display: none;">阵法</button>
                            <button id="inventory-btn" style="background-color: #795548;">背包</button>
                            <button id="debug-btn" style="background-color: #607D8B;">调试功能</button>
                        </div>
                    </div>
                    <div class="lobby-right">
                        <!-- Player preview will be drawn on canvas behind here -->
                        <h2>玩家状态</h2>
                        <div class="player-stats-scroll">
                            <div id="player-stats-display" class="player-stats-panel">
                                <div class="stat-card" data-stat="hp">
                                    <span class="stat-label">生命</span>
                                    <span class="stat-value" id="stat-hp">0</span>
                                    <span class="stat-hint">ℹ️</span>
                                </div>
                                <div class="stat-card" data-stat="physique">
                                    <span class="stat-label">体魄</span>
                                    <span class="stat-value" id="stat-physique">0</span>
                                    <span class="stat-hint">ℹ️</span>
                                </div>
                                <div class="stat-card" data-stat="strength">
                                    <span class="stat-label">力量</span>
                                    <span class="stat-value" id="stat-strength">0</span>
                                    <span class="stat-hint">ℹ️</span>
                                </div>
                                <div class="stat-card" data-stat="agility">
                                    <span class="stat-label">敏捷</span>
                                    <span class="stat-value" id="stat-agility">0</span>
                                    <span class="stat-hint">ℹ️</span>
                                </div>
                                <div class="stat-card" data-stat="comprehension">
                                    <span class="stat-label">悟性</span>
                                    <span class="stat-value" id="stat-comprehension">0</span>
                                    <span class="stat-hint">ℹ️</span>
                                </div>
                                <div class="stat-card" data-stat="defense">
                                    <span class="stat-label">防御</span>
                                    <span class="stat-value" id="stat-defense">0</span>
                                    <span class="stat-hint">ℹ️</span>
                                </div>
                                <div class="stat-card" data-stat="spiritualPower">
                                    <span class="stat-label">灵力</span>
                                    <span class="stat-value" id="stat-spiritualPower">0</span>
                                    <span class="stat-hint">ℹ️</span>
                                </div>
                                <div class="stat-card" data-stat="speed">
                                    <span class="stat-label">速度</span>
                                    <span class="stat-value" id="stat-speed">0</span>
                                    <span class="stat-hint">ℹ️</span>
                                </div>
                                <div class="stat-card" data-stat="critChance">
                                    <span class="stat-label">暴击率</span>
                                    <span class="stat-value" id="stat-critChance">0%</span>
                                    <span class="stat-hint">ℹ️</span>
                                </div>
                                <div class="stat-card" data-stat="critDamage">
                                    <span class="stat-label">暴击伤害</span>
                                    <span class="stat-value" id="stat-critDamage">200%</span>
                                    <span class="stat-hint">ℹ️</span>
                                </div>
                                <div class="stat-card" data-stat="soulAmp">
                                    <span class="stat-label">灵魂增幅</span>
                                    <span class="stat-value" id="stat-soulAmp">0%</span>
                                    <span class="stat-hint">ℹ️</span>
                                </div>
                                <div id="active-formation-wrapper" class="stat-card formation-card hidden">
                                    <div class="formation-card-header">
                                        <p class="formation-card-title">已启用战斗阵法</p>
                                        <p class="formation-card-subtitle">阵法效果叠加在此查看</p>
                                    </div>
                                    <div id="active-formation-list" class="formation-badge-list"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="level-selection-screen" class="screen hidden">
                <h1>选择关卡</h1>
                <div class="level-tabs" style="display: flex; justify-content: center; gap: 20px; margin-bottom: 20px;">
                    <button class="tab-btn active" data-tab="body-refining" onclick="window.switchLevelTab('body-refining')">锻体期 (1-30)</button>
                    <button class="tab-btn" data-tab="qi-refining" onclick="window.switchLevelTab('qi-refining')">练气期 (31-60)</button>
                </div>
                <div id="level-list" class="upgrade-container" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 40px 20px; max-height: 70vh; overflow-y: auto; width: 85%; align-items: start; justify-content: center; padding: 20px;">
                    <!-- Levels will be injected here -->
                </div>
                <button id="btn-back-lobby-levels" style="margin-top: 20px; background-color: #607D8B;">返回大厅</button>
            </div>

            <div id="game-over-screen" class="screen hidden">
                <h1>游戏结束</h1>
                <p id="loss-gold-display" style="color: #ff4444; font-size: 24px; margin: 20px 0;">损失灵石: 0</p>
                <button id="restart-btn">重新开始</button>
                <button id="lobby-btn">返回大厅</button>
            </div>
            
            <!-- 新的通关结算 UI (右下角) -->
            <div id="level-cleared-overlay" class="hidden" style="position: absolute; bottom: 30px; right: 30px; background: rgba(0,0,0,0.8); padding: 25px; border-radius: 15px; border: 2px solid #87CEEB; text-align: right; z-index: 100; min-width: 300px;">
                <h2 style="color: #87CEEB; margin: 0 0 15px 0; font-size: 28px;">关卡完成!</h2>
                <p id="level-reward-display" style="color: white; margin-bottom: 20px; font-size: 18px;">获得灵石: 0 | 气血: 0</p>
                <div style="display: flex; gap: 15px; justify-content: flex-end;">
                    <button id="overlay-lobby-btn" style="padding: 12px 24px; font-size: 18px; background-color: #607D8B;">返回大厅</button>
                    <button id="overlay-next-level-btn" style="padding: 12px 24px; font-size: 18px; background-color: #4CAF50;">下一关</button>
                </div>
            </div>

            <div id="affix-selection-overlay" class="hidden">
                <div class="affix-modal">
                    <h2 style="margin-top: 0; font-size: 32px; color: #FFB74D;">灵纹觉醒</h2>
                    <p style="color: #ccc; margin-bottom: 20px;">击杀达到阶段后，可从以下词缀中任选一项加持。</p>
                    <div id="affix-choice-list" class="affix-choice-grid"></div>
                    <button id="affix-skip-btn" style="background-color: #607D8B; margin-top: 10px;">暂时跳过</button>
                </div>
            </div>

            <div id="upgrade-screen" class="screen hidden">
                <h1>修炼</h1>
                <div id="cultivation-reiki-display" style="color: #00ffff; font-size: 20px; margin-bottom: 15px;">当前灵气: 0</div>
                
                <!-- 气血锻体进度条 (常驻) -->
                <div id="body-strengthening-panel" class="hidden" style="width: 80%; max-width: 800px; margin-bottom: 20px; background: rgba(100, 50, 50, 0.3); padding: 15px; border-radius: 8px; border: 1px solid #d32f2f;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <h3 style="margin: 0; color: #ff5252; font-size: 18px;">气血锻体 Lv.<span id="body-str-level">0</span></h3>
                        <span style="font-size: 14px; color: #ccc;">体魄 +<span id="body-str-bonus">0</span></span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="flex: 1; background: #555; height: 20px; border-radius: 10px; position: relative; overflow: hidden;">
                            <div id="body-str-progress-bar" style="width: 0%; background: #d32f2f; height: 100%; transition: width 0.3s;"></div>
                            <span id="body-str-progress-text" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 12px; text-shadow: 1px 1px 2px black;">0 / 0</span>
                        </div>
                        <button id="btn-strengthen-body" style="background-color: #d32f2f; padding: 5px 15px; font-size: 14px; margin: 0;">锻体</button>
                    </div>
                </div>

                <div class="cultivation-container">
                    <div class="cultivation-tabs">
                        <button class="tab-btn active" data-tab="mortal">凡人</button>
                        <button class="tab-btn" data-tab="body-refining">锻体</button>
                        <button class="tab-btn" data-tab="qi-refining">练气</button>
                        <button class="tab-btn" data-tab="foundation">筑基</button>
                        <button class="tab-btn" data-tab="golden-core">金丹</button>
                        <button class="tab-btn" data-tab="nascent-soul">元婴</button>
                        <button class="tab-btn" data-tab="soul-formation">化神</button>
                        <button class="tab-btn" data-tab="tribulation">渡劫</button>
                        <button class="tab-btn" data-tab="mahayana">大乘</button>
                    </div>
                    <div class="cultivation-content">
                        <div id="content-mortal" class="tab-content">
                            <div id="mortal-process">
                                <h2>凡人阶段</h2>
                                <p>肉体凡胎，未入仙途。</p>
                                <p>需消耗 20 灵气感应天地，方可踏入修炼之路。</p>
                                <button id="btn-breakthrough-mortal" style="background-color: #FF9800; margin-top: 20px;">感应天地 (消耗: 20 灵气)</button>
                            </div>
                            <div id="mortal-completed" class="hidden">
                                <h2>凡人阶段</h2>
                                <p>您已踏入仙人之路。</p>
                            </div>
                        </div>
                        <div id="content-body-refining" class="tab-content hidden">锻体内容 (空)</div>
                        <div id="content-qi-refining" class="tab-content hidden">练气内容 (空)</div>
                        <div id="content-foundation" class="tab-content hidden">筑基内容 (空)</div>
                        <div id="content-golden-core" class="tab-content hidden">金丹内容 (空)</div>
                        <div id="content-nascent-soul" class="tab-content hidden">元婴内容 (空)</div>
                        <div id="content-soul-formation" class="tab-content hidden">化神内容 (空)</div>
                        <div id="content-tribulation" class="tab-content hidden">渡劫内容 (空)</div>
                        <div id="content-mahayana" class="tab-content hidden">大乘内容 (空)</div>
                    </div>
                </div>
                <button id="btn-back-lobby" style="margin-top: 20px; background-color: #607D8B;">返回大厅</button>
            </div>

            <div id="forging-screen" class="screen hidden">
                <h1>锻造</h1>
                <div class="forging-container">
                    <div class="forging-tabs">
                        <button class="tab-btn active" data-tab="wood">木制品</button>
                        <button class="tab-btn" data-tab="iron">铁制品</button>
                        <button class="tab-btn" data-tab="refined-iron">精铁制品</button>
                    </div>
                    <div class="forging-content">
                        <div id="content-wood" class="tab-content">
                            <h2>木制品锻造</h2>
                            <div id="forging-list-wood" class="upgrade-container"></div>
                        </div>
                        <div id="content-iron" class="tab-content hidden">
                            <h2>铁制品锻造</h2>
                            <div id="forging-list-iron" class="upgrade-container"></div>
                        </div>
                        <div id="content-refined-iron" class="tab-content hidden">
                            <h2>精铁制品锻造</h2>
                            <div id="forging-list-refined-iron" class="upgrade-container"></div>
                        </div>
                    </div>
                </div>
                <button id="btn-back-lobby-forging" style="margin-top: 20px; background-color: #607D8B;">返回大厅</button>
            </div>

            <div id="smelting-screen" class="screen hidden">
                <h1>熔炼</h1>
                <div class="smelting-container" style="display: flex; flex-direction: column; align-items: center; gap: 20px; width: 80%; max-width: 800px;">
                    <div class="upgrade-container" style="width: 100%; display: flex; justify-content: space-around; flex-wrap: wrap;">
                        <!-- Smelting Items will be injected by JS -->
                    </div>
                </div>
                <button id="btn-back-lobby-smelting" style="margin-top: 20px; background-color: #607D8B;">返回大厅</button>
            </div>

            <div id="formation-screen" class="screen hidden">
                <h1>阵法</h1>
                <div class="formation-container" style="display: flex; flex-direction: column; align-items: center; gap: 20px; width: 80%; max-width: 800px; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px; height: 60%;">
                    <div class="formation-tabs" style="display: flex; gap: 20px; margin-bottom: 10px;">
                        <button class="tab-btn active" data-tab="gathering" onclick="window.switchFormationTab('gathering')">聚灵阵法</button>
                        <button class="tab-btn" data-tab="combat" onclick="window.switchFormationTab('combat')">战斗阵法</button>
                    </div>
                    <div id="formation-list" class="upgrade-container" style="width: 100%; display: flex; justify-content: center; flex-wrap: wrap; overflow-y: auto;">
                        <!-- Formation Items will be injected by JS -->
                    </div>
                </div>
                <button id="btn-back-lobby-formation" style="margin-top: 20px; background-color: #607D8B;">返回大厅</button>
            </div>

            <div id="inventory-screen" class="screen hidden">
                <h1>背包</h1>
                <div class="inventory-container" style="display: flex; width: 80%; height: 60%; background: rgba(0,0,0,0.8); border-radius: 10px; overflow: hidden;">
                    <div class="inventory-tabs" style="width: 150px; background: rgba(255,255,255,0.1); display: flex; flex-direction: column;">
                        <button class="tab-btn active" data-tab="items">道具</button>
                        <button class="tab-btn" data-tab="weapons">武器</button>
                    </div>
                    <div class="inventory-content" style="flex: 1; padding: 20px; overflow-y: auto; text-align: left;">
                        <div id="content-items" class="tab-content">
                            <div id="inventory-list" class="upgrade-container">
                                <p style="color: #aaa; font-size: 18px;">暂无道具</p>
                            </div>
                        </div>
                        <div id="content-weapons" class="tab-content hidden">
                            <div id="inventory-weapon-list" class="upgrade-container">
                                <!-- Weapons will be injected here -->
                            </div>
                        </div>
                    </div>
                </div>
                <button id="btn-inventory-back-lobby" style="margin-top: 30px; background-color: #607D8B; z-index: 100; cursor: pointer; position: relative;">返回大厅</button>
            </div>

            <div id="debug-screen" class="screen hidden" style="background: rgba(0,0,0,0.8); z-index: 50;">
                <div style="background: #333; padding: 40px; border-radius: 15px; border: 1px solid #555; display: flex; flex-direction: column; align-items: center; min-width: 300px;">
                    <h1 style="margin-top: 0;">调试功能</h1>
                    <div class="upgrade-container" style="flex-direction: column; align-items: center;">
                        <div style="margin: 20px 0; display: flex; gap: 10px; align-items: center;">
                            <input type="number" id="test-exp-input" placeholder="输入气血值" style="width: 150px; padding: 10px; font-size: 16px; border-radius: 5px; border: none;">
                            <button id="test-add-exp-btn" style="background-color: #2196F3; margin: 0;">增加气血</button>
                        </div>

                        <div style="margin: 20px 0; display: flex; gap: 10px; align-items: center;">
                            <input type="number" id="test-reiki-input" placeholder="输入灵气值" style="width: 150px; padding: 10px; font-size: 16px; border-radius: 5px; border: none;">
                            <button id="test-add-reiki-btn" style="background-color: #00BFFF; margin: 0;">增加灵气</button>
                        </div>
                        
                        <div style="margin: 20px 0; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; justify-content: center;">
                            <select id="debug-item-select" style="padding: 10px; font-size: 16px; border-radius: 5px; border: none; min-width: 150px;">
                                <!-- Options will be populated by JS -->
                            </select>
                            <input type="number" id="debug-item-count" placeholder="数量" value="1" style="width: 80px; padding: 10px; font-size: 16px; border-radius: 5px; border: none;">
                            <button id="debug-add-item-btn" style="background-color: #4CAF50; margin: 0;">添加道具</button>
                        </div>

                        <div style="margin: 20px 0; display: flex; gap: 10px; align-items: center;">
                            <input type="number" id="test-gold-input" placeholder="输入灵石值" style="width: 150px; padding: 10px; font-size: 16px; border-radius: 5px; border: none;">
                            <button id="test-add-gold-btn" style="background-color: #FFD700; color: black; margin: 0;">增加灵石</button>
                        </div>

                        <button id="debug-unlock-levels-btn" style="background-color: #9C27B0; margin-top: 10px;">解锁所有关卡</button>

                        <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                            <button onclick="window.queueBattleBuff(1, 10)" style="background-color: #E91E63;">Buff: 攻击 (+20%)</button>
                            <button onclick="window.queueBattleBuff(2, 10)" style="background-color: #3F51B5;">Buff: 防御 (+10)</button>
                            <button onclick="window.queueBattleBuff(3, 10)" style="background-color: #009688;">Buff: 移速 (+30%)</button>
                        </div>

                        <button id="clear-data-btn" style="background-color: #f44336; margin-top: 20px;">清除所有存档</button>
                    </div>
                    <button id="btn-close-debug" style="margin-top: 30px; background-color: #607D8B;">关闭</button>
                </div>
            </div>

            <div id="pause-screen" class="screen hidden" style="background: rgba(0,0,0,0.5);">
                <h1>暂停</h1>
                <button id="resume-btn">继续游戏</button>
                <button id="quit-lobby-btn" style="background-color: #f44336;">退出到大厅</button>
            </div>

            <div id="confirm-quit-modal" class="screen hidden" style="background: rgba(0,0,0,0.8); z-index: 30;">
                <div style="background: #333; padding: 30px; border-radius: 10px; text-align: center; border: 1px solid #555; max-width: 500px;">
                    <h2>确认退出?</h2>
                    <p style="color: #ff4444; margin: 20px 0;">退出将损失本局获得的所有道具!</p>
                    <div id="session-items-list" style="background: #222; padding: 15px; border-radius: 5px; margin: 20px 0; max-height: 200px; overflow-y: auto; text-align: left;">
                        <!-- 动态显示本局获得的道具 -->
                    </div>
                    <div style="display: flex; justify-content: center; gap: 20px;">
                        <button id="confirm-quit-yes" style="background-color: #f44336;">确认退出</button>
                        <button id="confirm-quit-no" style="background-color: #607D8B;">取消</button>
                    </div>
                </div>
            </div>

            <!-- Offline Reward Modal -->
            <div id="offline-reward-modal" class="screen hidden" style="background: rgba(0,0,0,0.8); z-index: 50;">
                <div style="background: #333; padding: 30px; border-radius: 10px; text-align: center; border: 1px solid #2196F3; max-width: 400px;">
                    <h2 style="color: #2196F3;">离线修炼收益</h2>
                    <p style="margin: 20px 0; font-size: 16px;">您离开期间，角色依然在勤勉修炼。</p>
                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                        <p>离线时长: <span id="offline-time-display" style="color: #fff;">0秒</span></p>
                        <p>获得灵气: <span id="offline-gain-display" style="color: #2196F3; font-weight: bold;">+0</span></p>
                    </div>
                    <button id="btn-claim-offline" style="background-color: #2196F3;">领取收益</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Tooltip (Moved to body for correct positioning independent of game scaling) -->
    <div id="game-tooltip" class="hidden" style="position: fixed; background: rgba(0, 0, 0, 0.9); color: white; padding: 10px; border: 1px solid #fff; border-radius: 5px; pointer-events: none; z-index: 2000; white-space: pre-line; font-size: 14px;"></div>

    <script type="module" src="/main.js"></script>
</body>
</html>